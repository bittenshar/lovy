# System Diagram - Message â†’ FCM Notification Complete Flow

## High-Level Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MESSAGING SYSTEM ARCHITECTURE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              CLIENT APPLICATIONS
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  â”‚                          â”‚                  â”‚
    â–¼                  â–¼                          â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Android  â”‚      â”‚   iOS    â”‚              â”‚   Web    â”‚      â”‚ Desktop  â”‚
â”‚  Phone   â”‚      â”‚  iPhone  â”‚              â”‚ Browser  â”‚      â”‚   App    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                         â”‚                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Firebase SDK sends FCM token on login
                        â”‚
                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              BACKEND API SERVER                       â”‚
    â”‚  (Node.js/Express)                                   â”‚
    â”‚                                                       â”‚
    â”‚  Endpoints:                                          â”‚
    â”‚  - POST /auth/register-fcm-token                     â”‚
    â”‚  - POST /conversations/:id/messages                  â”‚
    â”‚  - GET /conversations/:id/messages                   â”‚
    â”‚  - POST /conversations                              â”‚
    â”‚  - POST /conversations/:id/mark-read                â”‚
    â”‚  - GET /conversations/fcm-health-check/:userId      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       DATABASE LAYER (MongoDB)                  â”‚
    â”‚                                                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Collections:                                    â”‚
    â”‚                                                 â”‚
    â”‚  1. userfcmtokens â­ (PRIMARY FOR FCM)         â”‚
    â”‚     â”œâ”€ userId (indexed)                        â”‚
    â”‚     â””â”€ tokens: [                               â”‚
    â”‚        â”œâ”€ token (FCM token string)             â”‚
    â”‚        â”œâ”€ deviceType (android|ios|web)        â”‚
    â”‚        â””â”€ isActive (true|false)               â”‚
    â”‚                                                 â”‚
    â”‚  2. conversations                               â”‚
    â”‚     â”œâ”€ participants (user IDs)                 â”‚
    â”‚     â”œâ”€ title                                    â”‚
    â”‚     â”œâ”€ lastMessage                              â”‚
    â”‚     â”œâ”€ unreadCount (map of user â†’ count)      â”‚
    â”‚     â””â”€ updatedAt                               â”‚
    â”‚                                                 â”‚
    â”‚  3. messages                                    â”‚
    â”‚     â”œâ”€ conversation (ref)                      â”‚
    â”‚     â”œâ”€ sender (user ID)                        â”‚
    â”‚     â”œâ”€ body                                     â”‚
    â”‚     â””â”€ createdAt                               â”‚
    â”‚                                                 â”‚
    â”‚  4. notifications                               â”‚
    â”‚     â”œâ”€ userId                                  â”‚
    â”‚     â”œâ”€ title                                    â”‚
    â”‚     â”œâ”€ body                                     â”‚
    â”‚     â”œâ”€ type (message|conversation_started)    â”‚
    â”‚     â”œâ”€ data                                     â”‚
    â”‚     â””â”€ read                                     â”‚
    â”‚                                                 â”‚
    â”‚  5. users                                       â”‚
    â”‚     â”œâ”€ email                                    â”‚
    â”‚     â”œâ”€ firstName, lastName                      â”‚
    â”‚     â”œâ”€ role                                     â”‚
    â”‚     â””â”€ password                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ (Firebase Credentials)
                        â”‚
                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        FIREBASE CLOUD MESSAGING (FCM)            â”‚
    â”‚                                                   â”‚
    â”‚  Admin SDK:                                      â”‚
    â”‚  - admin.messaging().send(message)             â”‚
    â”‚  - Send to FCM tokens                          â”‚
    â”‚  - Handle device-specific formats              â”‚
    â”‚  - Return delivery status                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Android  â”‚ â”‚   iOS    â”‚ â”‚   Web    â”‚
    â”‚ Devices  â”‚ â”‚ Devices  â”‚ â”‚ Browsers â”‚
    â”‚  (GCM)   â”‚ â”‚ (APNs)   â”‚ â”‚ (FCM)    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚           â”‚            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ”” USER RECEIVES        â”‚
        â”‚     NOTIFICATION         â”‚
        â”‚     ON THEIR DEVICE(S)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Sending Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User A initiates message send                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              POST /conversations/{conversationId}/messages
              Body: { body: "Hello User B!" }
              Headers: { Authorization: "Bearer <token>" }
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: conversation.controller.sendMessage()                       â”‚
â”‚                                                                       â”‚
â”‚ Validation:                                                          â”‚
â”‚ âœ“ User is logged in                                                â”‚
â”‚ âœ“ User is participant of conversation                              â”‚
â”‚ âœ“ Message body is provided                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Create & Save Message                                       â”‚
â”‚                                                                       â”‚
â”‚ INSERT INTO messages:                                               â”‚
â”‚ {                                                                    â”‚
â”‚   conversation: conversationId,                                    â”‚
â”‚   sender: userId_A,                                                â”‚
â”‚   body: "Hello User B!",                                           â”‚
â”‚   createdAt: now                                                   â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Update Conversation Metadata                                â”‚
â”‚                                                                       â”‚
â”‚ UPDATE conversations:                                               â”‚
â”‚ {                                                                    â”‚
â”‚   lastMessage: messageId,                                          â”‚
â”‚   lastMessageText: "Hello User B!",                                â”‚
â”‚   lastMessageSenderId: userId_A,                                   â”‚
â”‚   lastMessageTime: now,                                            â”‚
â”‚   unreadCount: {                                                   â”‚
â”‚     userId_A: 0,        â† Sender's count reset                    â”‚
â”‚     userId_B: 3         â† Receiver's count incremented           â”‚
â”‚   }                                                                 â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Create Notification Record                                  â”‚
â”‚                                                                       â”‚
â”‚ INSERT INTO notifications:                                          â”‚
â”‚ {                                                                    â”‚
â”‚   userId: userId_B,                                                â”‚
â”‚   title: "John Doe",                                               â”‚
â”‚   body: "Hello User B!",                                           â”‚
â”‚   type: "message",                                                 â”‚
â”‚   data: {                                                          â”‚
â”‚     conversationId, messageId, senderId, senderName, ...          â”‚
â”‚   },                                                                â”‚
â”‚   read: false                                                      â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Return Response (HTTP 201)                                  â”‚
â”‚                                                                       â”‚
â”‚ Response to Client:                                                â”‚
â”‚ {                                                                    â”‚
â”‚   status: "success",                                               â”‚
â”‚   data: { messageId, conversationId, body, sender, createdAt }   â”‚
â”‚ }                                                                    â”‚
â”‚                                                                       â”‚
â”‚ â±ï¸  Duration: ~50ms (synchronous)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        [Response sent to User A immediately]
        [Message appears in User A's app]
                      â”‚
                      â”‚ (async, non-blocking)
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Get Receiver ID                                             â”‚
â”‚                                                                       â”‚
â”‚ const receiverId = conversation.participants.find(                â”‚
â”‚   p => p !== senderId                                             â”‚
â”‚ )                                                                    â”‚
â”‚                                                                       â”‚
â”‚ Result: userId_B                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Call FCM Notification Function                              â”‚
â”‚                                                                       â”‚
â”‚ conversationFcmUtils.notifyNewMessage(                             â”‚
â”‚   receiverId = userId_B,                                          â”‚
â”‚   senderName = "John Doe",                                        â”‚
â”‚   messagePreview = "Hello User B!",                               â”‚
â”‚   conversationId,                                                  â”‚
â”‚   messageId,                                                       â”‚
â”‚   messageFull = "Hello User B!"                                   â”‚
â”‚ )                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Prepare Notification Data                                   â”‚
â”‚                                                                       â”‚
â”‚ notificationUtils.sendTemplatedNotification(                       â”‚
â”‚   userId_B,                                                        â”‚
â”‚   templateName = "messageReceived",                               â”‚
â”‚   templateArgs = ["John Doe", "Hello User B!"],                  â”‚
â”‚   additionalData = {                                              â”‚
â”‚     data: {                                                       â”‚
â”‚       type: "new_message",                                        â”‚
â”‚       conversationId,                                             â”‚
â”‚       messageId,                                                  â”‚
â”‚       senderId,                                                   â”‚
â”‚       ...                                                         â”‚
â”‚     }                                                              â”‚
â”‚   }                                                                 â”‚
â”‚ )                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 10: â­ QUERY FCM TOKENS (FIXED)                               â”‚
â”‚                                                                       â”‚
â”‚ const userFcmData = await UserFcmToken.findOne({                  â”‚
â”‚   userId: userId_B                                                â”‚
â”‚ })                                                                  â”‚
â”‚                                                                       â”‚
â”‚ Returns:                                                           â”‚
â”‚ {                                                                    â”‚
â”‚   userId: userId_B,                                               â”‚
â”‚   tokens: [                                                       â”‚
â”‚     {                                                             â”‚
â”‚       token: "cfkDjSEsHlU:APA91bGy2mH...",                       â”‚
â”‚       deviceType: "android",                                     â”‚
â”‚       isActive: true                                             â”‚
â”‚     },                                                            â”‚
â”‚     {                                                             â”‚
â”‚       token: "e5_TlsGn_-Y:APA91bJx3qK...",                      â”‚
â”‚       deviceType: "web",                                         â”‚
â”‚       isActive: true                                             â”‚
â”‚     },                                                            â”‚
â”‚     {                                                             â”‚
â”‚       token: "fGlEmTfGo_Z:APA91bKz4rL...",                      â”‚
â”‚       deviceType: "ios",                                         â”‚
â”‚       isActive: false  â† INACTIVE (skip this)                  â”‚
â”‚     }                                                             â”‚
â”‚   ]                                                               â”‚
â”‚ }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 11: Filter Active Tokens                                       â”‚
â”‚                                                                       â”‚
â”‚ const tokens = userFcmData.tokens.filter(t => t.isActive)        â”‚
â”‚                                                                       â”‚
â”‚ Result:                                                            â”‚
â”‚ [                                                                   â”‚
â”‚   { token: "cfkDj...", deviceType: "android", isActive: true }, â”‚
â”‚   { token: "e5_Tl...", deviceType: "web", isActive: true }     â”‚
â”‚ ]                                                                  â”‚
â”‚                                                                       â”‚
â”‚ Total active tokens: 2                                             â”‚
â”‚ (iOS token skipped because isActive = false)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
        â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 12A:            â”‚    â”‚ STEP 12B:            â”‚
â”‚ Send to Android      â”‚    â”‚ Send to Web          â”‚
â”‚ Token               â”‚    â”‚ Token               â”‚
â”‚                      â”‚    â”‚                      â”‚
â”‚ Build message:       â”‚    â”‚ Build message:       â”‚
â”‚ {                    â”‚    â”‚ {                    â”‚
â”‚   token: "cfkDj...", â”‚    â”‚   token: "e5_Tl...",â”‚
â”‚   notification: {    â”‚    â”‚   notification: {    â”‚
â”‚     title: "John", â”‚    â”‚     title: "John", â”‚
â”‚     body: "Hello"  â”‚    â”‚     body: "Hello"  â”‚
â”‚   },               â”‚    â”‚   },               â”‚
â”‚   data: {...},     â”‚    â”‚   data: {...},     â”‚
â”‚   android: {       â”‚    â”‚   webpush: {       â”‚
â”‚     notification: ..â”‚    â”‚     notification: ..â”‚
â”‚   }                â”‚    â”‚   }                â”‚
â”‚ }                    â”‚    â”‚ }                    â”‚
â”‚                      â”‚    â”‚                     â”‚
â”‚ Call:                â”‚    â”‚ Call:               â”‚
â”‚ admin.messaging()    â”‚    â”‚ admin.messaging()   â”‚
â”‚   .send(message)     â”‚    â”‚   .send(message)    â”‚
â”‚                      â”‚    â”‚                     â”‚
â”‚ Response:            â”‚    â”‚ Response:           â”‚
â”‚ "1234567890"         â”‚    â”‚ "0987654321"        â”‚
â”‚ (Message ID)         â”‚    â”‚ (Message ID)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 13: Compile Results                                            â”‚
â”‚                                                                       â”‚
â”‚ {                                                                    â”‚
â”‚   success: true,                                                   â”‚
â”‚   sent: 2,              â† 2 devices received notification        â”‚
â”‚   failed: 0,            â† No failures                            â”‚
â”‚   responses: [                                                    â”‚
â”‚     { token: "cfkDj...", status: "sent", response: "12345..." },â”‚
â”‚     { token: "e5_Tl...", status: "sent", response: "09876..." } â”‚
â”‚   ]                                                               â”‚
â”‚ }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Log: FCM Notifications Complete â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
        â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User B's     â”‚          â”‚ User B's     â”‚
    â”‚ Android      â”‚          â”‚ Web Browser  â”‚
    â”‚ Phone        â”‚          â”‚              â”‚
    â”‚              â”‚          â”‚              â”‚
    â”‚ ğŸ”” PING ğŸ””  â”‚          â”‚ ğŸ”” NOTIFY ğŸ”” â”‚
    â”‚              â”‚          â”‚              â”‚
    â”‚ Notification â”‚          â”‚ Notification â”‚
    â”‚ Received!    â”‚          â”‚ Received!    â”‚
    â”‚              â”‚          â”‚              â”‚
    â”‚ From: John   â”‚          â”‚ From: John   â”‚
    â”‚ "Hello User" â”‚          â”‚ "Hello User" â”‚
    â”‚              â”‚          â”‚              â”‚
    â”‚ [Tap to open]â”‚          â”‚ [Click to    â”‚
    â”‚              â”‚          â”‚  open]       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ âœ… SUCCESS           â”‚
            â”‚ User B receives      â”‚
            â”‚ message notificationâ”‚
            â”‚ on ALL devices       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Time Distribution

```
HTTP Request â†’ Response:        ~50ms   (Synchronous)
â”œâ”€ Database validation         ~5ms
â”œâ”€ Message creation            ~10ms
â”œâ”€ Conversation update         ~10ms
â”œâ”€ Notification record         ~10ms
â””â”€ Response sent              ~5ms

FCM Notification (Async):      ~100ms total
â”œâ”€ Get receiver ID             ~2ms
â”œâ”€ Query userfcmtokens         ~15ms  â­ KEY QUERY
â”œâ”€ Filter active tokens        ~1ms   â­ FILTERING
â”œâ”€ Build Firebase messages     ~10ms
â”œâ”€ Send to Android device      ~30ms
â”œâ”€ Send to Web device          ~30ms
â””â”€ Logging                     ~2ms

Device Delivery:               ~1-5 seconds
â””â”€ Firebase â†’ Device network
```

## Key Operations in Code

```javascript
// STEP 10 - Query user's FCM tokens (FIXED)
const userFcmData = await UserFcmToken.findOne({ 
  userId: receiverId  // â† Receiver's user ID
});

// STEP 11 - Filter active tokens (FIXED)
const tokens = userFcmData && userFcmData.tokens 
  ? userFcmData.tokens.filter(t => t.isActive)  // â† Only active
  : [];

// STEP 12 - Send to Firebase
for (const t of tokens) {
  const message = {
    token: t.token,              // â† Individual FCM token
    notification: {
      title: senderName,
      body: messagePreview
    },
    data: { ... },
    // Device-specific: android/apns/webpush
  };
  
  const response = await admin.messaging().send(message);
  // Response: Firebase Message ID
}
```

## Success Indicators

âœ… **All working correctly when:**
1. `sent: > 0` in response
2. All receiver's active devices receive notification
3. `[CONV-FCM] Result - Success: true, Sent: X` in logs
4. No Firebase errors in console
5. Notification appears within 1-5 seconds on devices

âŒ **Something's wrong if:**
1. `sent: 0` and tokens exist - Check filtering
2. Tokens found but `isActive: false` - User logged out
3. No tokens found - User never registered FCM
4. Firebase errors - Check credentials
5. No server logs - Async error caught silently
